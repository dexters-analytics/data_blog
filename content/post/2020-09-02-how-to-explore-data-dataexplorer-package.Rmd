---
title: 'How to Explore Data: {DataExplorer} Package'
author: "Jason Dexter"
date: '2020-09-07'
#draft: yes
slug: how-to-explore-data-dataexplorer-package
categories: R
tags:
- r packages
- data wrangling
- eda
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE)
```

![](/post/2020-09-02-how-to-explore-data-dataexplorer-package_files/01_exploring_data.png)

<br/>

`Exploring-Data` is a place where I share easily digestible content aimed at making the wrangling and exploration of data more efficient (+fun).

Sign up [Here](https://tinyletter.com/dexters-analytics){target="_blank"} to join the many other subscribers who also nerd out on new tips and tricks ðŸ¤“

Where am I advancing my R skills?

1. Business Science University
2. R-bloggers

Join me on the journey ðŸƒâ€â™‚  ðŸƒâ€â™€

### Series: Exploring R {packages}

This is the 2nd post in the new series on `Exploring` `R` `{packages}`.

I have a habit of finding one or two useful `functions` in a `{package}`, but rarely explore further to discover other useful functionality.

In this series I'm testing the idea of breaking that habit and sharing what I learn along the way.

In each post, I will share a bit about how I was using a `{package}`and then use a case-study to highlight other `functionality` I discovered to be useful.


### DataExplorer {package}

You can tell by the name of my blog that `{DataExplorer}` is perfectly suited for this series on `R``{packages}`.

[Boxuan Cui](https://www.linkedin.com/in/boxuancui/){target="_blank"} is the developer and maintainer of the `package` and at it's core is designed to "simplify and automate EDA." 

Take the time to explore the [Github Page](http://boxuancui.github.io/DataExplorer/){target="_blank"} for the `{DataExplorer::package}`, where Sam describes it as follow:

> Exploratory Data Analysis (EDA) is the initial and an important phase of data analysis/predictive modeling. During this process, analysts/modelers will have a first look of the data, and thus generate relevant hypotheses and decide next steps. However, the EDA process could be a hassle at times. This R package aims to automate most of data handling and visualization, so that users could focus on studying the data and extracting insights.

<center>
![](/post/2020-09-02-how-to-explore-data-dataexplorer-package_files/DataExplorer-180x180.png)
</center>

<br/>

Just about every time I'm working with new data, I'm loading `{DataExplorer}` from my library of `R` `{packages}`.

However, I'm typically only using the `plot_missing()` function.

While `Exploring` the `package` further I was excited to discover `functionality` that is now part of my EDA toolbox ðŸ§°


### Case-Study

The case-study will provide and illustrate the following:

1. The `function` I use often: `DataExplorer::plot_missing()`.
2. Newly discovered `functions` from `{DataExplorer}`.  


### Load Packages

```{r}
# Core Packages
library(tidyverse)
library(tidyquant)
library(knitr)

# Data Cleaning
library(janitor)

# EDA
library(skimr)
library(DataExplorer)
library(correlationfunnel)

# ggplot2 Helpers
library(scales)

# Geographic
library(countrycode)
```


### Import Data

```{r}
# tuesdata <- tidytuesdayR::tt_load(2020, week = 28)
# coffee_ratings <- tuesdata$coffee_ratings

#coffee_ratings_tbl <- read_csv("static/01_data/coffee_ratings.csv")
coffee_ratings_tbl <- read_csv("../../static/01_data/coffee_ratings.csv")

```


### Data Understanding

Set up preprocessing pipeline (we will build on it)

Initial investigation made it clear to remove some cols


### Data Analysis (exploration)

```{r}


coffee_rating_preprocessed_tbl <- coffee_ratings_tbl %>% 
  
  # drop unnecessary columns
  select(-in_country_partner, -contains("certification")) %>% 
    
  # add unique id
  mutate(id = row_number())  
  
skim(coffee_rating_preprocessed_tbl)

coffee_rating_preprocessed_tbl %>% plot_missing()
coffee_rating_preprocessed_tbl %>% plot_bar(maxcat = 50, ncol = 2, nrow = 2, ggtheme = theme_tq())
coffee_rating_preprocessed_tbl %>% plot_histogram(ncol = 3, nrow = 2, ggtheme = theme_tq())
```



### Data Understanding


### Exploratory Data Analysis


### Preprocessing Data Pipeline

Bringing it all together from what we've learning

```{r}
# # reminder of raw-data
# raw_data
# 
# # reminder of preprocessing/cleaning
# data_processed
# 
# # setup recipe based on eda findings
# preprocessing_recipe
# 
# # add recipe to preprocessing data pipeline
# data_processed
```



```{r}
knitr::knit_exit()
```




```{r}


coffee_ratings


coffee_ratings %>% count(country_of_origin, sort = T)

# data pre-processing
coffee_ratings_processed <- coffee_ratings %>% 
    select(species, country_of_origin, harvest_year, grading_date,
           number_of_bags, altitude_mean_meters, total_cup_points) %>% 
    filter(total_cup_points > 0, 
           !is.na(country_of_origin)) %>% 
    mutate(country_of_origin = case_when(
        country_of_origin == "Cote d?Ivoire" ~ "Cote d'Ivoire",
        country_of_origin == "Tanzania, United Republic Of" ~ "Tanzania",
        #country_of_origin == "United States (Puerto Rico)" ~ "Puerto Rico",
        TRUE ~ country_of_origin)) %>% 
    mutate(harvest_year = case_when(
        harvest_year == "August to December" ~ "2010",
        harvest_year == "08/09 crop" ~ "2008",
        harvest_year == "1t/2011" ~ "2011",
        harvest_year == "1T/2011" ~ "2011",
        harvest_year == "23 July 2010" ~ "2010",
        harvest_year == "3T/2011" ~ "2011",
        harvest_year == "47/2010" ~ "2010",
        harvest_year == "4T/10" ~ "2010",
        harvest_year == "4t/2010" ~ "2010",
        harvest_year == "4T/2010" ~ "2010",
        harvest_year == "4t/2011" ~ "2011",
        harvest_year == "4T72010" ~ "2010",
        TRUE ~ harvest_year)) %>% 
    mutate(harvest_year = parse_number(harvest_year) %>% as.factor(),
           harvest_year = fct_explicit_na(harvest_year, na_level = "missing"),
           harvest_year = as.character(harvest_year),
           altitude_mean_feet = altitude_mean_meters * 3.28084) %>% 
    mutate(harvest_year = case_when(
        harvest_year == "missing" ~ str_sub(grading_date, str_count(grading_date)-3),
        TRUE ~ harvest_year
    )) %>% 
    mutate(harvest_year = case_when(harvest_year == "017\n" ~ "2017",
                                    TRUE ~ harvest_year)) %>% 
    mutate(continent = countrycode(country_of_origin, "country.name", "continent")) %>% 
    select(-altitude_mean_meters) %>% 
    select(continent, country_of_origin, everything())



skimr::skim(coffee_ratings_processed) 

```




```{r}


# what are the counts of ratings over time?
coffee_ratings_processed %>% 
    count(harvest_year) %>% 
    ggplot(aes(harvest_year, n)) +
    geom_col() +
    labs(title = "Coffee Rating Counts by Year",
         subtitle = "The dataset is incomplete with 2012 to 2017 having the most substative data.")

# how do coffee ratings change as altitude increases?
# is there a relationship between altitude and coffee ratings?
coffee_ratings_processed %>% 
    filter(altitude_mean_feet <= 30000) %>% 
    ggplot(aes(altitude_mean_feet, total_cup_points)) +
    geom_point() +
    geom_smooth(method = "lm") +
    scale_x_continuous(label = scales::comma_format()) #+
    #ylim(0, 100)

# what are the most common elevations for coffee farms (by continent)?
# slightly misleanding b/c not aggreated to farms first (this is ratings so farms can be multiple times)
coffee_ratings_processed %>% 
    filter(altitude_mean_feet <= 30000) %>% 
    ggplot(aes(altitude_mean_feet, fill = continent)) +
    geom_histogram(binwidth = 300)

# which countries in each continent have the most coffee ratings?
coffee_ratings_processed %>% 
    count(continent, country_of_origin) %>% 
    arrange(continent, desc(n)) 


# Mapping Coffee Ratings
library(maps)
maps::iso3166 %>% tibble() 

world <- map_data("world") %>% tibble() %>% filter(region != "Antarctica")

coffee_ratings_processed %>%
    group_by(continent, country_of_origin) %>% 
    summarize(mean_rating = mean(total_cup_points)) %>% 
    ungroup() %>% 
    #distinct(continent, country_of_origin) %>% 
    right_join(world, by = c(country_of_origin = "region")) %>% 
    ggplot(aes(long, lat, group = group, fill = mean_rating)) +
    geom_polygon() +
    coord_map(xlim=c(-180,180), ylim=c(-55, 80)) +
    scale_fill_gradient2(low = "white", high = "darkgreen", midpoint = 78) +
    theme_void() 



# how do coffee ratings vary? Looks like they follow a normal distribution.
coffee_ratings_processed %>% 
    ggplot(aes(total_cup_points)) +
    geom_histogram(binwidth = 1) +
    xlim(50, 100) +
    labs(title = "Overall distribution of Coffee Ratings",
         subtitle = "Normal distribution, some outliers seen at lower values between 60 to 70.",
         x = "Coffee Ratings", y = "Count")

# were the really low scores from farms that had small sample sizes (# of bags)?
coffee_ratings_processed %>% 
    filter(total_cup_points < 70)
# not really. i wonder what explains the low scores? same farm?

#

# which countries have the highest average coffee ratings?
# follow up: how much different are the wtd means?
mean_ratings_by_country <- coffee_ratings_processed %>% 
    group_by(country_of_origin) %>% 
    summarise(mean_rating = mean(total_cup_points),
          wtd_mean_rating = weighted.mean(total_cup_points, w = number_of_bags),
          change = mean_rating - wtd_mean_rating) %>% 
    ungroup() %>% 
    arrange(desc(mean_rating)) %>% 
    mutate(country_of_origin = fct_reorder(country_of_origin, wtd_mean_rating))

mean_ratings_by_country %>% 
    ggplot(aes(country_of_origin, wtd_mean_rating)) +
    geom_col() +
    coord_flip()

# how do coffee ratings vary by country?
coffee_ratings_processed %>% 
    mutate(country_of_origin = fct_reorder(country_of_origin, total_cup_points)) %>% 
    ggplot(aes(x = country_of_origin, y = total_cup_points, fill = country_of_origin)) +
    geom_boxplot(show.legend = F) +
    coord_flip() +
    ylim(0, 100)

# which countries have the highest ratings?
coffee_ratings_processed %>% 
    arrange(desc(total_cup_points))

library(countrycode)
?countrycode

africa_ratings <- coffee_ratings_processed %>% 
    mutate(continent = countrycode(country_of_origin, "country.name", "continent")) %>% 
    filter(continent == "Africa") %>% 
    rename(country = country_of_origin) %>% 
    mutate(harvest_year = parse_number(harvest_year),
           harvest_year = as.factor(harvest_year)) %>% 
    filter(!is.na(harvest_year))

# how many coffees were rated each year in Africa?
africa_ratings %>% 
    count(harvest_year, sort = T) %>% 
    ggplot(aes(x = harvest_year, y = n)) +
    geom_col()

# What was the average rating each year (by country)?
# looks like some countries are very data limited.
africa_ratings %>% 
    group_by(country, harvest_year) %>% 
    summarize(mean_rating = mean(total_cup_points)) %>% 
    ungroup() %>% 
    
    ggplot(aes(harvest_year, mean_rating, fill = country)) +
    geom_col(show.legend = F) +
    scale_fill_tq() +
    facet_wrap(~country, nrow = 5) +
    ylim(0, 100)

africa_ratings %>% 
    ggplot(aes(total_cup_points, fill = country)) +
    geom_histogram(show.legend = F) +
    scale_fill_tq() +
    facet_wrap(~country, nrow = 5) 

africa_ratings %>% 
    count(country, harvest_year) %>% view()
```





